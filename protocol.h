#ifndef _PROTOCOL_H_
#define _PROTOCOL_H_
//#include "main.h"

#include "common.h"
#include "Serial.h"
#pragma pack(1)

typedef unsigned          char uint8_t;
typedef unsigned short     int uint16_t;
typedef unsigned           int uint32_t;

typedef unsigned          char UINT8;
typedef unsigned short     int UINT16;
typedef unsigned          char U8;
typedef unsigned short     int U16;

//prorocol struck
extern const UINT16 CRC16Table[256];
extern uint8_t FingerImageBuf[256][360];
extern uint8_t ImageBuf[];
#define Empty	1
#define	Full 	2
#ifndef TRUE
#define TRUE	1
#define FALSE	0
#endif


#define Protocol_SendOver	19	//包头2 	设备地址 4	连机密码4	包标号2	命令码2	包标识1	数据长度2	校验和2
#define Protocol_RevOver	21	//包头2 	设备地址 4	连机密码4	包标号2	命令码2	包标识1	数据长度2	确认码2		校验和2

#define Pack_Head		0x02EF
#define Device_Addr  	0x04030201		//?豸???????0x00000000~0xFFFFFFFF????0xFFFFFFFF???????????????????????豸?????????????????????
#define	Connect_PW		0x01020304//????????
#define Pack_NO			
#define CMD_Code
#define Pack_sign				0x01
#define Pack_Len								//<1024
#define Pack_Data								//<531
#define Pack_crc16
#define Pack_ACK_sign		0x02
#define Pack_ACK     
#define Pack_size sizeof(_Rev_pack_struct)

extern UINT16 CmdReturnCode[];
extern CSerial	g_Serial;
//string  MessageStr[];

struct _soft_param{
    BOOL ComTimeOut;
    U16  ComWaitCmd;
    U16	 PackNo;
    U8	 ComPort;
    UINT ComPortBaudRate;
    U8   ComPortState;
    U16  CmdCode;
};

extern _soft_param SoftParam;

struct Rev_struct{
    uint16_t 		Head;
    uint32_t		Addr;
    uint32_t  		Password;
    uint16_t		NO;
    uint16_t  		CMD;
    uint8_t			Sign;
    uint16_t  		Length;
    uint16_t		ACK;
    uint8_t			Revbuf[530];

};

struct _Rev_pack_struct{
    struct Rev_struct rev_stc;
    uint16_t	Revpt;
    uint8_t 	RevCp;
};

extern struct _Rev_pack_struct Rev_pack;
struct _Send_pack_struct{
    uint16_t	Head;
    uint32_t	Addr;
    uint32_t	Password;
    uint16_t	NO;
    uint16_t	CMD;
    uint8_t		Sign;
    uint16_t	Length;
    uint8_t		Sendbuf[532];
    //	uint16_t  crc16;
};

extern	struct _Send_pack_struct SendPack;
struct image_struct{
    uint8_t  bufIsEmpty;
    uint16_t width;
    uint16_t high;
    uint16_t readLine;
    uint16_t Length;
};
extern struct image_struct imageInfo;
extern uint8_t    Revbuf[549];
extern uint8_t    Sendbuf[549];

///////////////////////命令码///////////////////////////////
#define	CMD_DEVICE_RESET	    	0x0320	    	//系统复位
#define	CMD_DETECT_FINGER	    	0x0321	    	//探测指纹
#define	CMD_GET_RAW_IMAGE	    	0x0322	    	//采集原始图像
#define	CMD_GET_REDRESS_IMAGE		0x0323	    	//采集矫正图像
#define	CMD_UPLOAD_IMAGE	    	0x0324	    	//上传图像(包括原始图像和矫正图像)
#define	CMD_GEN_CHAR	    	   	0x0325	    	//生成模板
#define	CMD_MATCH_CHAR	    	   	0x0326	    	//比对模板
#define	CMD_STORE_CHAR	    	   	0x0327	    	//存储模板
#define	CMD_SEARCH_CHAR	    	   	0x0328	    	//搜索模板
#define	CMD_DELETE_CHAR	    	   	0x0329	    	//删除指定模板
#define	CMD_EMPTY_CHAR	    	   	0x032A	    	//清空模板库
#define	CMD_VERIFY_CHAR	    	   	0x032B	    	//单一比对模板
#define	CMD_GET_CHAR	    	   	0x032C			//获取模板
#define	CMD_PUT_CHAR	    	   	0x032D			//下载模板
#define	CMD_GET_MBINDEX	    	   	0x032E	    	//获取MBIndex
#define	CMD_READ_NOTE_BOOK	    	0x032F	    	//读记事本
#define	CMD_WRITE_NOTE_BOOK	    	0x0330	    	//写记事本
#define	CMD_READ_PAR_TABLE	    	0x0331	    	//读取参数表
#define	CMD_SET_BAUD_RATE	    	0x0332			//设置波特率
#define	CMD_SET_SECURLEVEL	    	0x0333	    	//设置指纹安全级别
#define	CMD_SET_CMOS_PARA	    	0x0334			//设置CMOS参数
#define	CMD_RESUME_FACTORY	    	0x0335	    	//恢复出厂设置
#define	CMD_MERGE_CHAR	    		0x0336			//合并特征
#define	CMD_SET_PSW	    			0x0337			//密码设置
#define	CMD_SET_ADDRESS	    		0x0338			//地址设置
#define	CMD_GET_RANDOM	    		0x0339			//获取随机数
#define	CMD_DOWNLOAD_IMAGE	    	0x0340	    	//下载指纹图像
#define	CMD_ERASE_PROGRAM	    	0x0341			//擦除程序标识
#define	CMD_STORE_CHAR_DIRECT	   	0x0342	    	//直接存储指纹模板
#define	CMD_READ_CHAR_DIRECT	   	0x0343	    	//直接根据地址读取指纹模板
#define	CMD_GET_FIRSTVALID_ADD		0x0344	    	//获取第一个空闲的指纹索引
#define	CMD_CHIP_ERASE	    		0x0380			//整片擦除FLASH
#define CMD_FINGER_DETECT			0X0400			//手指检测
#define	CMD_Sleep_MODE				0X0401			//sleep模式
#define CMD_SleepToIdle				0x0402
#define CMD_AdjustImage				0x0403
//返回码		    		    	
#define	CMD_RT_OK	    									0x0000	    	//命令执行完毕或OK
#define	CMD_RT_PACKGE_ERR	    					0x0001	    	//数据包接收错误
#define	CMD_RT_DEVICE_ADDRESS_ERR				0x0002	    	//设备地址错误
#define	CMD_RT_COM_PASSWORD_ERR	  			0x0003	    	//通信密码错误
#define	CMD_RT_NO_FINGER	    					0x0004	    	//传感器上没有手指
#define	CMD_RT_GET_IMAGE_FAIL	    			0x0005	    	//从传感器上获取图像失败
#define	CMD_RT_GEN_CHAR_ERR	    				0x0006	    	//生成特征失败
#define	CMD_RT_FINGER_MATCH_ERR	  			0x0007	    	//指纹不匹配
#define	CMD_RT_FINGER_SEARCH_FAIL				0x0008	    	//没搜索到指纹
#define	CMD_RT_MERGE_TEMPLET_FAIL				0x0009	    	//特征合并失败
#define	CMD_RT_ADDRESS_OVERFLOW	  			0x000A	    	//将模板存库时地址序号超出指纹库范围
#define	CMD_RT_READ_TEMPLET_ERR	  			0x000B	    	//从指纹库读模板出错
#define	CMD_RT_UP_TEMPLET_ERR	    			0x000C	    	//上传特征失败
#define	CMD_RT_UP_IMAGE_FAIL	    			0x000D	    	//上传图像失败
#define	CMD_RT_DELETE_TEMPLET_ERR				0x000E	    	//删除模板失败
#define	CMD_RT_CLEAR_TEMPLET_LIB_ERR		0x000F	    	//清空指纹库失败
#define	CMD_RT_FINGER_NOT_MOVE	    		0x0010	    	//残留指纹或传感器窗口的按指长时间未移开
#define	CMD_RT_NO_TEMPLET_IN_ADDRESS		0x0011	    	//指定位置没有有效模板
#define	CMD_RT_CHAR_REPEAT	    				0x0012	    	//指纹重复，需要注册的指纹已经在FLASH中注册
#define	CMD_RT_MB_NOT_EXIST_IN_ADDRESS	0x0013	    	//该地址中不存在指纹模板
#define	CMD_RT_GET_MBINDEX_OVERFLOW	    0x0014	    	//获取模板索引长度溢出
#define	CMD_RT_SET_BAUD_RATE_FAIL	    	0x0015	    	//设置波特率失败
#define	CMD_RT_ERASE_FLAG_FAIL	    		0x0016	    	//擦除程序标志失败
#define	CMD_RT_SYSTEM_RESET_FAIL	    	0x0017	    	//系统复位失败
#define	CMD_RT_OPERATION_FLASH_ERR	    0x0018	    	//操作FLASH出错
#define	CMD_RT_NOTE_BOOK_ADDRESS_OVERFLOW	 0x0019	    //记事本地址溢出
#define	CMD_RT_PARA_ERR	    			0x001A	    	//设置参数错误
#define	CMD_RT_NO_CMD	    				0x001B	    	//命令不存在

//extern void protocol_deal(struct _Rev_pack_struct *R_pack);
//
// extern void GET_RAW_IMAGE(struct image_struct *image );
// extern void sendCaptureCmd(uint8_t *Sendbuf);
extern BOOL SendCommand(U16 CmdCode,U8 *Data,U16 Len);

extern U8 Asc2Hex(CString strasc);
extern UINT16 GetCRC16(UINT8 *pSource,UINT16 len);
extern const UINT16 CRC16Table[256];


#endif




