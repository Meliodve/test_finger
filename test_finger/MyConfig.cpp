#include "stdafx.h"

// 全局唯一配置
MyConfig conf;

// 默认配置
void MyConfig::defaultConfig(){
    if(!m.count("SaveConf")){
        m["SaveConf"]=Stringify(false);
    }
    // 若SaveConf为false,则都用默认设置
    bool give=m["SaveConf"]==Stringify(false);

    if(give||!m.count("AdvDbg")){
        m["AdvDbg"]=Stringify(false);
    }
    if(give||!m.count("AutoCheck")){
        m["AutoCheck"]=Stringify(true);
    }
    if(give||!m.count("AutoLog")){
        m["AutoLog"]=Stringify(true);
    }
    if(give||!m.count("RemBaud")){
        m["RemBaud"]=Stringify(true);
    }
    if(give||!m.count("RemProtocol")){
        m["RemProtocol"]=Stringify(true);
    }
    if(give||!m.count("Baud")){
        if(m["RemBaud"]==Stringify(true)){
            m["Baud"]="2";
        }
    }
    if(give||!m.count("ProtocolType")){
        if(m["RemProtocol"]==Stringify(true)){
            m["ProtocolType"]="0";
        }
    }
    return;
}

// 构造函数是从文件中读取配置
MyConfig::MyConfig(){
    MyFile::ReadConfig(
        [&](FILE* fp){
            char buffer[1<<16],key[1<<6],val[1<<6];
            char* p=buffer;
            // 一下子全部取负读入
            while((*p++=-fgetc(fp))!=-EOF);
            // 补零回退,补零是为了结束字符串
            *--p=0;
            int n,c=0;
            while(buffer[c]){
                sscanf(buffer+c,"%[^`]`%[^`]`%n",key,val,&n);
                c+=n;
                m[key]=val;
            }
        }
    );
    defaultConfig();
}

// 析构函数是把配置写到文件里
MyConfig::~MyConfig(){
    if(m["SaveConf"]==Stringify(true)){
        MyFile::WriteConfig(
            [&](FILE* fp){
                for(auto it=m.begin();it!=m.end();it++){
                    for(auto jt=it->first.c_str();*jt;jt++){
                        fputc(-*jt,fp);
                    }
                    fputc(-'`',fp);
                    for(auto jt=it->second.c_str();*jt;jt++){
                        fputc(-*jt,fp);
                    }
                    fputc(-'`',fp);
                }
            }
        );
    }
}

// 像map<string,string>一样,键类型是字符串,值类型也是字符串
std::string& MyConfig::operator[](std::string s){
    return m[s];
}

std::string MyConfig::Bool(bool b){
    return b?Stringify(true):Stringify(false);
}
